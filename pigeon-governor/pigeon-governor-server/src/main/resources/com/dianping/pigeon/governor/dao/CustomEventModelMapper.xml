<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dianping.pigeon.governor.dao.CustomEventModelMapper" >
    <resultMap id="BaseResultMap" type="com.dianping.pigeon.governor.model.EventModel" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jul 29 11:28:48 CST 2016.
        -->
        <id column="id" property="id" jdbcType="INTEGER" />
        <result column="event_type" property="eventType" jdbcType="INTEGER" />
        <result column="project_id" property="projectId" jdbcType="INTEGER" />
        <result column="relate_project_id" property="relateProjectId" jdbcType="INTEGER" />
        <result column="event_signature" property="eventSignature" jdbcType="VARCHAR" />
        <result column="level" property="level" jdbcType="INTEGER" />
        <result column="title" property="title" jdbcType="VARCHAR" />
        <result column="summary" property="summary" jdbcType="VARCHAR" />
        <result column="updateTime" property="updatetime" jdbcType="TIMESTAMP" />
    </resultMap>
    <resultMap id="ResultMapWithBLOBs" type="com.dianping.pigeon.governor.model.EventModelWithBLOBs" extends="BaseResultMap" >
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
          This element was generated on Fri Jul 29 11:28:48 CST 2016.
        -->
        <result column="content" property="content" jdbcType="LONGVARCHAR" />
        <result column="send_status" property="sendStatus" jdbcType="LONGVARCHAR" />
    </resultMap>
    <select id="getHotProjects" parameterType="java.lang.Integer" resultMap="ResultMapWithBLOBs">
        SELECT * FROM event WHERE project_id in (SELECT project_id FROM event WHERE event_type = 1 group BY project_id HAVING COUNT(project_id)>#{0})
        AND event_type = 1
    </select>
    <select id="getRecentEvents" resultMap="ResultMapWithBLOBs">
        SELECT * FROM event ORDER BY event.updatetime DESC limit #{size}
    </select>
    <select id="filterEvents" resultMap="ResultMapWithBLOBs">
        SELECT * FROM event
        WHERE event.updatetime &gt;= #{start} AND event.updatetime &lt;= #{end}
        <if test="projectId != -1">
            AND ( #{projectId} = project_id OR #{projectId} = relate_project_id )
        </if>
        <if test="levels.size > 0">
            AND event.level IN
            <foreach collection="levels" index="index" item="level" open="(" close=")" separator=",">
                #{level}
            </foreach>
        </if>
        <if test="types.size > 0">
            AND event.event_type IN
            <foreach collection="types" index="index" item="type" open="(" close=")" separator=",">
                #{type}
            </foreach>
        </if>
    </select>
    <select id="getTotalCount" resultType="java.lang.Integer">
        SELECT count(*) FROM event
    </select>

</mapper>