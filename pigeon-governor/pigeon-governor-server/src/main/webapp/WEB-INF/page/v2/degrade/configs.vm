#set($layout="layoutblank.vm")
<div class="modal fade" id="modal" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">

                <button type="button" class="bootbox-close-button close" data-dismiss="modal" aria-hidden="true" style="margin-top: -10px;">×</button>
                <h4 class="modal-title blue" id="modal-title"></h4>
            </div>
            <div class="modal-body">
                <div class="form-group row">
                    <label class="col-sm-2 control-label blue" for="service-name">服务名</label>
                    <div class="col-sm-9">
                        <input type="text" placeholder="" id="service-name" class="col-xs-12 col-sm-12" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-2 control-label blue" for="method-name">方法名</label>
                    <div class="col-sm-9">
                        <input type="text" placeholder="" id="method-name" class="col-xs-12 col-sm-12" />
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-2 control-label blue" for="select-type">返回方式</label>
                    <div class="col-sm-9">
                        <select id="select-type" class="chosen-select">
                            <option value="0">默认方式</option>
                            <option value="1">指定返回值</option>
                            <option value="2">抛出异常</option>
                            <option value="3">Mock</option>
                        </select>
                    </div>
                </div>
                <div id ="form-1" class="form-group row">
                    <label class="col-sm-2 control-label blue" for="default-value">默认返回值</label>
                    <div class="col-sm-9">
                        <input type="text" disabled placeholder="null" id="default-value" class="col-xs-12 col-sm-12" />
                    </div>
                </div>
                <div id = "form-2">
                    <div class="form-group row">
                        <label class="col-sm-2 control-label blue" for="class-name">returnClass</label>
                        <div class="col-sm-9">
                            <input type="text" placeholder="" id="class-name" class="col-xs-12 col-sm-12" />
                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-2 control-label blue" for="return-content">Content</label>
                        <div class="col-sm-9">
                            <input type="text" placeholder="" id="return-content"class="col-xs-12 col-sm-12" />
                        </div>
                    </div>
                </div>
                <div id ="form-3" class="form-group row">
                    <label class="col-sm-2 control-label blue" for="exception-value">异常信息</label>
                    <div class="col-sm-9">
                        <input type="text" disabled placeholder='{"throwException":"true"}' id="exception-value" class="col-xs-12 col-sm-12" />
                    </div>
                </div>
                <div id ="form-test" class="form-group row">
                    <label class="col-sm-2 control-label blue" for="mock-name">Mock impl name</label>
                    <div class="col-sm-9">
                        <input type="text" placeholder="" id="mock-name" class="col-xs-12 col-sm-12" />
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button id="submit" data-bb-handler="success" type="button" class="btn btn-sm btn-success" data-dismiss="modal"><i class="ace-icon fa fa-check"></i>Confirm</button>
            </div>
        </div>
    </div>
</div>




<table  class="table table-striped table-bordered table-hover">
    <thead>
    <tr>
        <th>服务名</th>
        <th>方法名</th>
        <th>方式</th>
        <th>返回值</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody>
        #foreach ($config in $configs)
        <tr>
            <td>$config.getServiceName()</td>
            <td>$config.getMethodName()</td>
            <td data-order="$config.getReturnPattern()" data-search="$config.getReturnPattern()">
                #if($config.getReturnPattern()==0)
                <span class="grey">默认方式</span>
                #else
                    #if($config.getReturnPattern()==1)
                        <span class="blue">指定返回值</span>
                    #else
                        #if($config.getReturnPattern()==2)
                            <span class="red">抛出异常</span>
                        #else
                            <span class="green">Mock</span>
                        #end
                    #end
                #end
            </td>
            <td data-order="$config.getReturnValue()" data-search="$config.getReturnValue()">
                #if($config.getReturnPattern()==0)
                    <span class="grey">null</span>
                #else
                    #if($config.getReturnPattern()==1)
                        <span class="blue">$config.getReturnValue()</span>
                    #else
                        #if($config.getReturnPattern()==2)
                            <span class="red">{"throwException":"true"}</span>
                        #else
                            <span class="green">MockImpl</span>
                        #end
                    #end
                #end
            </td>
            <td>
                <div class="hidden-sm hidden-xs action-buttons">
                    <a  class="primary config-update">
                        <i class="ace-icon fa fa-pencil bigger-130"></i>
                    </a>
                    <a class="red config-delete">
                        <i class="ace-icon fa fa-times bigger-130"></i>
                    </a>
                </div>
            </td>
        </tr>
        #end
    </tbody>
</table>
<script>
    function updateConfig(ajaxContent){
        $.ajax({
            type: "post",
            url:ajaxContent.url,
            data:ajaxContent.data,
            dataType: "html",
            async: true,
            success: function (data) {
                bootbox.dialog({
                    message: "开启成功!",
                    buttons: {
                        "success": {
                            "label": "<i class='ace-icon fa fa-check'></i> Confirm",
                            "className": "btn-sm btn-success"
                        }
                    }
                });
            }
        });
    }
    function modalInit(obj,projectName,title){
        var tr = $(obj).parents("tr");
        var serviceName = $(tr.children()[0]).html();
        var methodName = $(tr.children()[1]).html();
        var returnPattern = $(tr.children()[2]).attr('data-order');
        var returnValue = $(tr.children()[3]).attr('data-order');
        $('#modal-title').html(title);
        $('#service-name').attr('placeholder', serviceName);
        $('#service-name').attr("disabled", "disabled");
        $("#method-name").attr("placeholder", methodName);
        $("#method-name").attr('disabled', "disabled");
        $('#modal').modal('show');
        var data = {"projectName":projectName,"serviceName":serviceName,"methodName":methodName};
        $("#select-type").val(returnPattern);
        return data;
    }
    jQuery(function($) {
        var projectName = $("#mainContent").parent().attr("data-project-name");
        $(document).ready(function () {
            $('table').DataTable({
                bAutoWidth: false,
                aoColumns: [
                    null,
                    null,
                    null,
                    null,
                    null
                ],
                "aaSorting": [],
                dom: "<'myRow'<'col-xs-8'><'col-xs-4'B>>" +
                "<'row aceTableRow'<'col-xs-3'l><'col-xs-9'fr>>" +
                "t" +
                "<'row'<'col-xs-3'i><'col-xs-9'p>>",
                buttons: [
                    {
                        text: ' <i class="ace-icon fa fa-trash-o bigger-120 danger"></i>',
                        action: function (e, dt, node, config) {

                        }
                    }
                ]
            });
        });
        $("#select-type").chosen({
            allow_single_deselect: false
        });
        $("#select-type").next().width("120px");
        $('table').delegate('.config-update','click',function () {
            var data =modalInit($(this),projectName,"更新服务降级配置");
            var selector = $("#select-type");
            selector.selector_input({
                submitObj: $("#submit"),
                selectorObj: selector,
                initSelectorIndex: selector.val(),
                inputObjs: [$("#form-1"), $("#form-2"), $("#form-3"), $("form-test")],
                callbacks: [
                    function () {
                        var rawValue="null";
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var className = $("#class-name").val();
                        var content = $("#return-content").val();
                        var rawValue = '{"returnClass":"'+className+'","content":"'+content+'"}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        console.log(ajaxContent);
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var rawValue='{"throwException":"true"}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var rawValue='{MockImpl:testMock}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    }
                ]
            });
        });
        $('#content').delegate('.config-delete','click',function () {
            var data =modalInit($(this),projectName,"删除服务降级配置");
            var selector = $("#select-type");
            selector.selector_input({
                submitObj: $("#submit"),
                selectorObj: selector,
                initSelectorIndex: selector.val(),
                inputObjs: [$("#form-1"), $("#form-2"), $("#form-3"), $("form-test")],
                callbacks: [
                    function () {
                        var rawValue="null";
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var className = $("#class-name").val();
                        var content = $("#return-content").val();
                        var rawValue = '{"returnClass":"'+className+'","content":"'+content+'"}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        console.log(ajaxContent);
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var rawValue='{"throwException":"true"}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    },
                    function () {
                        var rawValue='{MockImpl:testMock}';
                        data.value=rawValue;
                        var ajaxContent={'url':'/config/degrade/update','data':data};
                        updateConfig(ajaxContent);
                    }
                ]
            });
        });
    });
</script>