#set($layout="layoutblank.vm")
<!DOCTYPE html>
<html>
<head>

    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta charset="utf-8" />
    <title>Pigeon</title>

    <meta name="description" content="pigeon config"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/font-awesome.min.css" />

    <!-- page specific plugin styles -->
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/jquery-ui.min.css" />
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/datepicker.css" />
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ui.jqgrid.css" />
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/jquery-ui.custom.min.css" />

    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/jquery.gritter.css" />

    <!-- text fonts -->
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace-fonts.css" />

    <!-- ace styles -->
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace.min.css" id="main-ace-style" />

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace-part2.min.css" />
    <![endif]-->
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace-skins.min.css" />
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace-rtl.min.css" />

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="${rc.contextPath}/resources/assets/css/ace-ie.min.css" />
    <![endif]-->

    <!-- inline styles related to this page -->

    <!-- ace settings handler -->
    <script src="${rc.contextPath}/resources/assets/js/ace-extra.min.js"></script>

</head>
<body class="no-skin">

<!-- #section:basics/navbar.layout -->
<div id="navbar" class="navbar navbar-default">
    #parse("common/navbar.vm")
</div>

<div class="main-container" id="main-container">

    <script type="text/javascript">
        try{ace.settings.check('main-container' , 'fixed')}catch(e){}
    </script>
    <!-- #section:basics/sidebar -->
    <div id="sidebar" class="sidebar   responsive">
        #parse("common/sidebar.vm")
    </div>
    <div class="main-content">

        <!-- #section:basics/content.breadcrumbs -->
        <div class="breadcrumbs" id="breadcrumbs">
            <script type="text/javascript">
                try {
                    ace.settings.check('breadcrumbs', 'fixed')
                } catch (e) {
                }
            </script>

            <ul class="breadcrumb">
                <li><i class="ace-icon fa fa-home home-icon"></i> <a href="/">主页</a>
                </li>
                <li>配置服务</li>
                <li class="active">${projectName}</li>
            </ul>
            <!-- /.breadcrumb -->
        </div>

        <!-- /section:basics/content.breadcrumbs -->
        <div class="page-content">

            <!-- /section:settings.box -->
            <div class="page-content-area">
                <div class="page-header">
                    <h1 class="header smaller lighter blue">
                        ${projectName}
                        <small>
                            <i class="ace-icon fa fa-angle-double-right"></i>
                            添加、删除、修改、查看pigeon服务配置
                        </small>
                    </h1>
                </div><!-- /.page-header -->

                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->

                        <div class="row"><!-- find project info from cmdb -->
                            <div class="col-xs-12">
                                <a class="btn btn-danger" href="http://web.cmdb.dp/?project=${projectName}" target="_blank">
                                    点击查询应用所属信息
                                </a>
                            </div>
                        </div>

                        <div class="row"><!-- service node datatable begins -->
                            <div class="col-xs-12">
                                <div class="table-header">
                                    加载服务配置
                                </div>

                                <!-- <div class="table-responsive"> -->

                                <!-- <div class="dataTables_borderWrap"> -->
                                <div>
                                    <table id="servicelist4project" class="table table-striped table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Group</th>
                                            <th>
                                                <i class="ace-icon fa fa-desktop bigger-110 hidden-480"></i>
                                                hosts
                                            </th>
                                            <th>
                                            #if(!$isProjectOwner)
                                                <a class="red" href="javascript:void(0)" onclick="adminApplyFunc(event)">
                                                    <i class="ace-icon fa fa-user red bigger-130"></i>
                                                </a>
                                            #else
                                                <a class="red" href="javascript:void(0)" onclick="addService(this)">
                                                    <i class="ace-icon fa fa-plus bigger-130"></i>
                                                </a>
                                            #end
                                            </th>
                                        </tr>
                                        </thead>

                                        <tbody>

                                        #foreach($service in $services)

                                        <tr id="service_$!{velocityCount}">
                                            <td>
                                                <a href="#">$!service.name</a>
                                            </td>
                                            <td class="hidden-480">
                                                <span class="label label-sm label-success">$!service.group</span>
                                            </td>
                                            <td class="hidden-480" style="word-break: break-all">$!service.hosts</td>

                                            <td>
                                                <div class="hidden-sm hidden-xs action-buttons">
                                            #if($isProjectOwner)
                                                    <a class="green" href="javascript:void(0)" onclick="editService(this)">
                                                        <i class="ace-icon fa fa-pencil bigger-130"></i>
                                                    </a>

                                                    #*<a class="red" href="#">
                                                        <i class="ace-icon fa fa-trash-o bigger-130"></i>
                                                    </a>*#
                                            #else
                                                <a class="red" href="javascript:void(0)" onclick="adminApplyFunc(event)">
                                                    <i class="ace-icon fa fa-user red bigger-130"></i>
                                                </a>
                                            #end
                                                </div>

                                            </td>
                                        </tr>

                                        #end

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div><!-- /.service node datatable ends -->

                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div>

        </div>
        <!-- /.page-content -->


    </div><!-- /.main-content -->

    <div class="footer">
        #parse("common/sub-footer.vm")
    </div>

    <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse">
        <i class="ace-icon fa fa-angle-double-up icon-only bigger-110"></i>
    </a>

    <!-- page hidden elements begins -->

    <div id="edit_hosts_info" class="modal fade" tabindex="-1"
         aria-hidden="true" data-backdrop="static" data-keyboard="false"
         data-hosts="" data-serviceid="" data-servicename="" data-group="" >
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="blue bigger">修改host信息</h4>
                    <small id="service_name">serviceName</small>
                    <br>
                    <small id="group">group</small>
                </div>

                <div class="modal-body">
                    <div class="row">

                        <div class="col-xs-12" id="host_line">
                            <!-- 这里面的动态画 -->
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button id="add_one_host" class="btn btn-sm btn-primary">
                        <i class="ace-icon fa fa-circle-o"></i>
                        添加
                    </button>

                    <button class="btn btn-sm" data-dismiss="modal">
                        <i class="ace-icon fa fa-times"></i>
                        取消
                    </button>

                    <button id="submit_edit_hosts" class="btn btn-sm btn-primary">
                        <i class="ace-icon fa fa-check"></i>
                        提交
                    </button>
                </div>

            </div>
        </div>
    </div>

    <div id="dialog-message" class="hide">
        <p>
            请点击<a href="http://crab.dp/cmdb/app_manage?project=${projectName}" target="_blank">此处</a>添加管理员邮箱到项目邮件组，然后点击按钮即可添加
        </p>

        <div class="hr hr-12 hr-double"></div>

        <p>
            <b class="red">项目邮件组添加完成后,点击OK即可.</b>
        </p>
    </div><!-- #dialog-message -->

    <!-- page hidden elements ends -->

</div>

<!-- basic scripts -->
<!--[if !IE]> -->
<script type="text/javascript">
    window.jQuery || document.write("<script src='${rc.contextPath}/resources/assets/js/jquery.min.js'>"+"<"+"/script>");
</script>
<!-- <![endif]-->
<!--[if IE]>
<script type="text/javascript">
    window.jQuery || document.write("<script src='${rc.contextPath}/resources/assets/js/jquery1x.min.js'>"+"<"+"/script>");
</script>
<![endif]-->
<script type="text/javascript">
    if('ontouchstart' in document.documentElement)
        document.write("<script src='${rc.contextPath}/resources/assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
</script>
<script src="${rc.contextPath}/resources/assets/js/bootstrap.min.js"></script>

<!-- page specific plugin scripts -->
<script src="${rc.contextPath}/resources/assets/js/date-time/bootstrap-datepicker.min.js"></script>
<script src="${rc.contextPath}/resources/assets/js/jquery.dataTables.min.js"></script>
<script src="${rc.contextPath}/resources/assets/js/jquery.dataTables.bootstrap.js"></script>

<script src="${rc.contextPath}/resources/assets/js/jquery-ui.min.js"></script>
<script src="${rc.contextPath}/resources/assets/js/jquery.ui.touch-punch.min.js"></script>

<script src="${rc.contextPath}/resources/assets/js/jquery-ui.custom.min.js"></script>

<script src="${rc.contextPath}/resources/assets/js/jquery.gritter.min.js"></script>

<script src="${rc.contextPath}/resources/js/my-array-ext.js"></script>

<!-- ace scripts -->
<script src="${rc.contextPath}/resources/assets/js/ace-elements.min.js"></script>
<script src="${rc.contextPath}/resources/assets/js/ace.min.js"></script>

<script>
    // 全局变量区域
    var dataTable;

    // js预加载
    $(function(){
        $('li[id="projects_index"]').addClass("active open");
        //$('li[id="project_info"]').addClass("active");
        $('[data-rel=tooltip]').tooltip();

        dataTable =
                $('#servicelist4project')
                .DataTable( {
                    bAutoWidth: false,
                    "aoColumns": [
                        null, null,null,
                        { "bSortable": false }
                    ],
                    "aaSorting": [],
                } );

    });

    // ******************************
    // 编辑服务地址相关方法 begins
    function addService(dom) {// 点击编辑 host 信息
        var onEditServiceTr = $(dom).closest('tr');
        var serviceNameDom = dataTable.cell(onEditServiceTr.find('td')[0]).data();
        var groupDom = dataTable.cell(onEditServiceTr.find('td')[1]).data();
        var hosts = dataTable.cell(onEditServiceTr.find('td')[2]).data();
        var serviceName = $(serviceNameDom).html();
        var group = $(groupDom).html();

        //保存下当前行的值
        $('#add_hosts_info').attr("data-serviceid", onEditServiceTr.attr('id'));
        $('#add_hosts_info').attr("data-hosts", hosts);
        $('#add_hosts_info').attr("data-servicename", serviceName);
        $('#add_hosts_info').attr("data-group", group);
        $('#add_hosts_info #service_name').html(serviceName);
        $('#add_hosts_info #group').html('分组：' + groupDom);

        var hostArr = hosts.split(",");
        var host_line = '';

        for (var i = 0; i < hostArr.length; ++i) {
            host_line += '<div class="form-group">'
            + '<input class="input-large" type="text" value="'
            + hostArr[i]
            + '" />'
            + '&nbsp;&nbsp;'
            + '<img src="${rc.contextPath}/resources/img/del.png" onclick="delsinglerow(this)">'
            + '</div>';
        }

        $('#edit_hosts_info #host_line').html(host_line);
        $('#edit_hosts_info').modal('show');
    }

    function editService(dom) {// 点击编辑 host 信息
        var onEditServiceTr = $(dom).closest('tr');
        var serviceNameDom = dataTable.cell(onEditServiceTr.find('td')[0]).data();
        var groupDom = dataTable.cell(onEditServiceTr.find('td')[1]).data();
        var hosts = dataTable.cell(onEditServiceTr.find('td')[2]).data();
        var serviceName = $(serviceNameDom).html();
        var group = $(groupDom).html();

        //保存下当前行的值
        $('#edit_hosts_info').attr("data-serviceid", onEditServiceTr.attr('id'));
        $('#edit_hosts_info').attr("data-hosts", hosts);
        $('#edit_hosts_info').attr("data-servicename", serviceName);
        $('#edit_hosts_info').attr("data-group", group);
        $('#edit_hosts_info #service_name').html(serviceName);
        $('#edit_hosts_info #group').html('分组：' + groupDom);

        var hostArr = hosts.split(",");
        var host_line = '';

        for (var i = 0; i < hostArr.length; ++i) {
            host_line += '<div class="form-group">'
                        + '<input class="input-large" type="text" value="'
                        + hostArr[i]
                        + '" />'
                        + '&nbsp;&nbsp;'
                        + '<img src="${rc.contextPath}/resources/img/del.png" onclick="delsinglerow(this)">'
                        + '</div>';
        }

        $('#edit_hosts_info #host_line').html(host_line);
        $('#edit_hosts_info').modal('show');
    }

    $('#submit_edit_hosts').on('click',function(e){ // 提交 host 修改请求
        var serviceName = $('#edit_hosts_info').attr("data-servicename");
        var group = $('#edit_hosts_info').attr("data-group");
        var oriHostsStr = $('#edit_hosts_info').attr("data-hosts");

        var inputArr = $('#edit_hosts_info input');
        var oriHostArr = oriHostsStr.split(",");
        var newHostArr = new Array();

        for (var i = 0; i < inputArr.length; ++i) {
            var host = $.trim(inputArr[i].value);

            if(host == "") { // 判空操作，返回false
                $.gritter.add({
                    title: "不允许为空!",
                    text: "请补充或删除空行后再次提交!",
                    class_name: 'gritter-error gritter-center gritter-light'
                });

                return false;
            }

            if (!newHostArr.contains(host)) {
                newHostArr.push(host);
            }
        }

        var toAddHostArr = Array.minus(newHostArr, oriHostArr);
        var toDelHostArr = Array.minus(oriHostArr, newHostArr);

        var data = {
            "serviceName" : serviceName,
            "group" : group,
            "toAddHosts" : toAddHostArr.join(","),
            "toDelHosts" : toDelHostArr.join(",")
        };

        // 服务器提交修改成功后，返回最新hosts，再修改页面缓存
        $.ajax({
            url: '${rc.contextPath}/services/edit/${projectName}',
            type: 'POST',
            data: data,
            error: function(response, textStatus){ // 500 etc.
                $.gritter.add({
                    title: response.status,
                    text: response.statusText,
                    class_name: 'gritter-error gritter-center gritter-light'
                });
            },
            success: function(response, textStatus) {
                if(response.status == "success") { // 更新本地缓存

                    var onEditServiceTrId = $('#edit_hosts_info').attr("data-serviceid");
                    var onEditServiceTr = $('#' + onEditServiceTrId);
                    dataTable.cell( onEditServiceTr.find('td')[2] ).data(newHostArr.join(",")).draw();

                    $('#edit_hosts_info').modal('hide');

                } else { // 报个错
                    $.gritter.add({
                        title: response.status,
                        text: response.message,
                        class_name: 'gritter-error gritter-center gritter-light'
                    });
                }

            }
        });
        // 各个按钮置为不可用

    });

    $('#add_one_host').on('click',function(e){ // 添加一行 host 编辑框
        //console.log(e.relatedTarget);

        var host_line = '<div class="form-group">'
                + '<input class="input-large" type="text" placeholder="ip:port, e.g. 10.1.77.131:5060" value="" />'
                + '&nbsp;&nbsp;'
                + '<img src="${rc.contextPath}/resources/img/del.png" onclick="delsinglerow(this)" />'
                + '</div>';

        $('#edit_hosts_info #host_line').append(host_line);
    });

    function delsinglerow(dom) { //删除所在行 host 编辑框
        $(dom).closest('div').remove();
    }
    // 编辑服务地址相关方法 ends
    // ******************************

    //override dialog's title function to allow for HTML titles
    $.widget("ui.dialog", $.extend({}, $.ui.dialog.prototype, {
        _title: function(title) {
            var $title = this.options.title || '&nbsp;'
            if( ("title_html" in this.options) && this.options.title_html == true )
                title.html($title);
            else title.text($title);
        }
    }));

    // 申请管理员
    var adminApplyFunc = function (e) {
        e.preventDefault();

        var dialog = $( "#dialog-message" ).removeClass('hide').dialog({
            modal: true,
            title: "<div class='widget-header widget-header-small'><h4 class='smaller'><i class='ace-icon fa fa-check'></i>申请管理员?</h4></div>",
            title_html: true,
            buttons: [
                {
                    text: "Cancel",
                    "class" : "btn btn-xs",
                    click: function() {
                        $( this ).dialog( "close" );
                    }
                },
                {
                    text: "OK",
                    "class" : "btn btn-primary btn-xs",
                    click: function() {
                        var currentUser = "${userName}";
                        var projectName = "${projectName}";
                        $.ajax({
                            url: '/projectowners/cmdb',
                            type: 'POST',
                            data:{"dpaccount": currentUser, "projectName": projectName},
                            error: function(){
                                console.log("server error!");
                            },
                            success: function(response, textStatus) {
                                //console.log(response.result);
                                window.location.reload();
                            }
                        });
                    }
                }
            ]
        });

    }

</script>

</body>
</html>